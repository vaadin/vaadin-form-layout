<!doctype html>

<head>
  <meta charset="UTF-8">
  <title>vaadin-form-layout tests</title>
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import" href="../vaadin-form-layout.html">
</head>

<body>
  <test-fixture id="default">
    <template>
      <vaadin-form-layout>
        <vaadin-text-field></vaadin-text-field>
        <paper-input></paper-input>
      </vaadin-form-layout>
    </template>
  </test-fixture>

  <test-fixture id="colspan">
    <template>
      <vaadin-form-layout columns="3">
        <vaadin-text-field></vaadin-text-field>
        <vaadin-text-field vaadin-form-layout-colspan="1"></vaadin-text-field>
        <vaadin-text-field vaadin-form-layout-colspan="2"></vaadin-text-field>
        <vaadin-text-field vaadin-form-layout-colspan="3"></vaadin-text-field>
        <vaadin-text-field vaadin-form-layout-colspan="4"></vaadin-text-field>
        <vaadin-text-field vaadin-form-layout-colspan="non-number"></vaadin-text-field>
      </vaadin-form-layout>
    </template>
  </test-fixture>

  <script>
    function getParsedWidth(el) {
      var width = el.style.getPropertyValue('width');
      var components = width.replace(/^calc\((.*)\)$/, '$1').split(' - ');
      return {
        percentage: components[0],
        gap: components[1]
      };
    }

    describe('basic features', function() {
      var layout, slot;

      beforeEach(function() {
        layout = fixture('default');
        slot = layout.shadowRoot.querySelector('slot');
      });

      it('should have slot', function() {
        expect(slot).to.be.ok;
      });

      it('should distribute vaadin-text-field', function() {
        var vaadinTextField = layout.querySelector('vaadin-text-field');
        expect(vaadinTextField).to.be.ok;
        expect(slot.assignedNodes()).to.contain(vaadinTextField);
      });

      it('should distribute paper-input', function() {
        var paperInput = layout.querySelector('paper-input');
        expect(paperInput).to.be.ok;
        expect(slot.assignedNodes()).to.contain(paperInput);
      });

    });

    describe('columns property', function() {
      var layout;

      beforeEach(function() {
        layout = fixture('default');
      });

      it('should have 2 columns by default', function() {
        expect(layout.columns).to.equal(2);
        var parsedWidth = getParsedWidth(layout.firstElementChild);
        expect(parseFloat(parsedWidth.percentage)).to.be.closeTo(50, .5);
      });

      it('should disallow invalid values, considering them as 1', function() {
        layout.columns = '';
        expect(layout.columns).to.equal(1);

        layout.columns = '2';
        expect(layout.columns).to.equal(1);

        layout.columns = 'foo';
        expect(layout.columns).to.equal(1);

        layout.columns = undefined;
        expect(layout.columns).to.equal(1);

        layout.columns = null;
        expect(layout.columns).to.equal(1);

        layout.columns = -1;
        expect(layout.columns).to.equal(1);

        layout.columns = 0;
        expect(layout.columns).to.equal(1);

        layout.columns = Infinity;
        expect(layout.columns).to.equal(1);

        layout.columns = NaN;
        expect(layout.columns).to.equal(1);
      });

      it('should assing width inline style on items', function() {
        layout.columns = 3;

        var parsedWidth = getParsedWidth(layout.firstElementChild);
        expect(parsedWidth.percentage).to.match(/%$/);
        expect(parseFloat(parsedWidth.percentage)).to.be.closeTo(33, .5);
      });
    });

    describe('column-gap CSS property', function() {
      var layout;

      beforeEach(function() {
        layout = fixture('default');
      });

      it('should apply default gap', function() {
        expect(getParsedWidth(layout.firstElementChild).gap).to.equal('2em');
      });

      it('should support updating with `updateStyles` call', function() {
        layout.updateStyles({'--vaadin-form-layout-column-gap': '1cm'});
        expect(getParsedWidth(layout.firstElementChild).gap).to.equal('1cm');
      });
    });

    describe('colspan', function() {
      var layout;

      beforeEach(function() {
        layout = fixture('colspan');
      });

      function estimateEffectiveColspan(el) {
        return parseFloat(getParsedWidth(el).percentage) / (100 / 3);
      }

      it('should span children correctly', function() {
        // empty means 1
        expect(estimateEffectiveColspan(layout.children[0])).to.be.closeTo(1, .1);

        // correct values
        expect(estimateEffectiveColspan(layout.children[1])).to.be.closeTo(1, .1);
        expect(estimateEffectiveColspan(layout.children[2])).to.be.closeTo(2, .1);
        expect(estimateEffectiveColspan(layout.children[3])).to.be.closeTo(3, .1);

        // if more then a number of columns, use number of columns
        expect(estimateEffectiveColspan(layout.children[4])).to.be.closeTo(3, .1);

        // invalid means 1
        expect(estimateEffectiveColspan(layout.children[5])).to.be.closeTo(1, .1);
      });
    });
  </script>
</body>
